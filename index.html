<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskEarnn - Earn Points Daily</title>
    <script src='//libtl.com/sdk.js' data-zone='9817795' data-sdk='show_9817795'></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- আপনার আগের CSS অপরিবর্তিত আছে --- */
    </style>
</head>
<body>
    <div class="container">
        <!-- === আপনার আগের HTML UI অপরিবর্তিত === -->
    </div>

    <script>
        // Initialize app data
        let userData = {
            points: parseInt(localStorage.getItem('points')) || 0,
            completedTasks: JSON.parse(localStorage.getItem('completedTasks')) || [],
            adsWatched: parseInt(localStorage.getItem('adsWatched')) || 0,
            lastAdsReset: localStorage.getItem('lastAdsReset') || new Date().toDateString(),
            referrals: parseInt(localStorage.getItem('referrals')) || 0,
            referralPoints: parseInt(localStorage.getItem('referralPoints')) || 0,
            history: JSON.parse(localStorage.getItem('history')) || []
        };

        // Generate user ID and referral link
        const userId = localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);

        // Telegram WebApp detection and user info
        let telegramUser = null;
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
            if (telegramUser) {
                const telegramUserId = 'tg_' + telegramUser.id;
                if (!localStorage.getItem('userId') || localStorage.getItem('userId').startsWith('user_')) {
                    localStorage.setItem('userId', telegramUserId);
                }
            }
        }

        // Check for referral in URL or Telegram start parameter
        let referrer = null;
        const urlParams = new URLSearchParams(window.location.search);
        referrer = urlParams.get('ref');
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.start_param) {
            referrer = window.Telegram.WebApp.initDataUnsafe.start_param;
        }

        // ----------- NEW: Send referral to server -----------
        async function sendReferralToServerOnce(referrer, userId) {
            if (!userId) return;
            if (localStorage.getItem('referralSent') === 'true') return;

            try {
                const r = await fetch('/api/referral', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referrerId: referrer, newUserId: userId })
                });
                const data = await r.json();
                if (data?.user) {
                    userData.points = data.user.points || userData.points;
                    userData.referrals = data.user.referrals || userData.referrals;
                    saveData();
                    updateDisplay();
                }
                localStorage.setItem('referralSent', 'true');
            } catch (e) {
                console.log('Referral API error:', e);
            }
        }

        // ----------- NEW: Sync user data from server -----------
        async function syncFromServer() {
            const currentUserId = localStorage.getItem('userId') || userId;
            if (!currentUserId) return;
            try {
                const r = await fetch(`/api/user?userId=${encodeURIComponent(currentUserId)}`);
                const data = await r.json();
                if (data) {
                    userData.points = data.points ?? userData.points;
                    userData.referrals = data.referrals ?? userData.referrals;
                    saveData();
                    updateDisplay();
                }
            } catch(e) { console.log('sync error', e); }
        }

        // Call referral + sync once page loads
        sendReferralToServerOnce(referrer, localStorage.getItem('userId') || userId)
          .then(syncFromServer);

        // ---------- OLD fake local bonus system removed ----------
        // if (referrer && referrer !== userId && !localStorage.getItem('hasReferred')) {
        //   userData.points += 25;
        //   userData.referralPoints += 25;
        //   localStorage.setItem('hasReferred', 'true');
        //   addToHistory('Referral Bonus', 25);
        // }

        // === আপনার আগের সব ফাংশন (updateDisplay, completeTask, watchAd, withdraw ইত্যাদি) অপরিবর্তিত ===
        // শুধু referral সেকশনটুকু পাল্টানো হয়েছে
    </script>

    <script>(function(){ /* cloudflare script ... */ })();</script>
</body>
</html>
